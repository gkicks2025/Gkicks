<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Debug Test - GKICKS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Token Debug Test</h1>
        <p>This page will automatically test the authentication flow and show debug information.</p>

        <div id="status" class="status"></div>
        
        <button class="button" onclick="runFullTest()">Run Full Test</button>
        <button class="button" onclick="clearAndTest()">Clear Storage & Test</button>
        
        <div id="output" class="output"></div>
    </div>

    <script>
        let output = document.getElementById('output');
        let status = document.getElementById('status');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function setStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
        }

        async function checkCurrentToken() {
            log('=== CHECKING CURRENT TOKEN ===');
            const token = localStorage.getItem('auth_token');
            
            if (!token) {
                log('‚ùå No token found in localStorage');
                return null;
            }
            
            log(`‚úÖ Token found (length: ${token.length})`);
            log(`Token preview: ${token.substring(0, 50)}...`);
            
            // Check token format
            const parts = token.split('.');
            log(`Token parts: ${parts.length} (should be 3 for JWT)`);
            
            if (parts.length === 3) {
                try {
                    const payload = JSON.parse(atob(parts[1]));
                    log(`Token payload: ${JSON.stringify(payload, null, 2)}`);
                } catch (e) {
                    log(`‚ùå Failed to decode token payload: ${e.message}`);
                }
            }
            
            return token;
        }

        async function testProfileAPI() {
            log('=== TESTING PROFILE API ===');
            const token = localStorage.getItem('auth_token');
            
            if (!token) {
                log('‚ùå No token available for API test');
                return false;
            }
            
            try {
                const response = await fetch('/api/profiles', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });
                
                log(`Profile API response: ${response.status} ${response.statusText}`);
                
                const data = await response.json();
                log(`Response data: ${JSON.stringify(data, null, 2)}`);
                
                return response.ok;
            } catch (error) {
                log(`‚ùå Profile API error: ${error.message}`);
                return false;
            }
        }

        async function testAddressesAPI() {
            log('=== TESTING ADDRESSES API ===');
            const token = localStorage.getItem('auth_token');
            
            if (!token) {
                log('‚ùå No token available for API test');
                return false;
            }
            
            try {
                const response = await fetch('/api/addresses', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });
                
                log(`Addresses API response: ${response.status} ${response.statusText}`);
                
                const data = await response.json();
                log(`Response data: ${JSON.stringify(data, null, 2)}`);
                
                return response.ok;
            } catch (error) {
                log(`‚ùå Addresses API error: ${error.message}`);
                return false;
            }
        }

        async function generateNewToken() {
            log('=== GENERATING NEW TOKEN ===');
            
            try {
                // Clear existing token
                localStorage.removeItem('auth_token');
                log('üóëÔ∏è Cleared existing token');
                
                const response = await fetch('/api/auth/session-to-jwt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`Session-to-JWT response: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.token) {
                        localStorage.setItem('auth_token', data.token);
                        log(`‚úÖ New token generated and stored`);
                        log(`Token: ${data.token.substring(0, 50)}...`);
                        log(`User: ${JSON.stringify(data.user, null, 2)}`);
                        return true;
                    } else {
                        log(`‚ùå No token in response: ${JSON.stringify(data, null, 2)}`);
                    }
                } else {
                    const errorData = await response.json();
                    log(`‚ùå Failed to generate token: ${JSON.stringify(errorData, null, 2)}`);
                }
            } catch (error) {
                log(`‚ùå Token generation error: ${error.message}`);
            }
            
            return false;
        }

        async function runFullTest() {
            log('\nüöÄ STARTING FULL AUTHENTICATION TEST\n');
            setStatus('Running full test...', 'info');
            
            // Step 1: Check current token
            await checkCurrentToken();
            
            // Step 2: Test APIs with current token
            const profileSuccess = await testProfileAPI();
            const addressSuccess = await testAddressesAPI();
            
            if (profileSuccess && addressSuccess) {
                log('\n‚úÖ All tests passed with current token!');
                setStatus('‚úÖ All tests passed!', 'success');
                return;
            }
            
            // Step 3: Generate new token if tests failed
            log('\nüîÑ Tests failed, generating new token...');
            const tokenGenerated = await generateNewToken();
            
            if (!tokenGenerated) {
                log('\n‚ùå Failed to generate new token');
                setStatus('‚ùå Failed to generate new token', 'error');
                return;
            }
            
            // Step 4: Test APIs with new token
            log('\nüß™ Testing APIs with new token...');
            const newProfileSuccess = await testProfileAPI();
            const newAddressSuccess = await testAddressesAPI();
            
            if (newProfileSuccess && newAddressSuccess) {
                log('\n‚úÖ All tests passed with new token!');
                setStatus('‚úÖ All tests passed with new token!', 'success');
            } else {
                log('\n‚ùå Tests still failing with new token');
                setStatus('‚ùå Tests still failing - check server logs', 'error');
            }
        }

        async function clearAndTest() {
            log('\nüóëÔ∏è CLEARING ALL STORAGE AND TESTING\n');
            setStatus('Clearing storage and testing...', 'info');
            
            // Clear all storage
            localStorage.clear();
            sessionStorage.clear();
            
            // Clear cookies
            const cookies = document.cookie.split(';');
            cookies.forEach(cookie => {
                const eqPos = cookie.indexOf('=');
                const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
                document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
            });
            
            log('üóëÔ∏è All storage cleared');
            
            // Run full test
            await runFullTest();
        }

        // Auto-run test on page load
        window.onload = function() {
            log('üîç Token Debug Test loaded');
            log('Click "Run Full Test" to start debugging\n');
        };
    </script>
</body>
</html>